// ===================================
// Authentication & Authorization
// ===================================

const authApp = {
    currentUser: null,

    init() {
        // Initialize database first
        db.init();
        
        // Check if user is already logged in
        const session = this.getSession();
        if (session) {
            this.currentUser = session;
            this.showMainApp();
        } else {
            this.showLoginScreen();
        }

        // Setup form handlers
        this.setupFormHandlers();
        
        // Populate team leaders in registration form
        this.populateTeamLeaders();
    },

    setupFormHandlers() {
        // Login form
        document.getElementById('loginForm').addEventListener('submit', (e) => {
            e.preventDefault();
            this.handleLogin();
        });

        // Registration form
        document.getElementById('registerForm').addEventListener('submit', (e) => {
            e.preventDefault();
            this.handleRegistration();
        });
    },

    populateTeamLeaders() {
        const users = db.getUsers() || [];
        const teamLeaders = users.filter(u => u.role === 'teamleader' && u.status === 'active');
        const select = document.getElementById('regTeamLeader');
        
        if (!select) return; // Element might not exist yet
        
        teamLeaders.forEach(leader => {
            const option = document.createElement('option');
            option.value = leader.id;
            option.textContent = leader.name;
            select.appendChild(option);
        });
    },

    handleLogin() {
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;

        // Make sure database is initialized
        const users = db.getUsers();
        if (!users || users.length === 0) {
            console.log('No users in database, initializing...');
            db.init();
        }

        const user = db.getUserByEmail(email);

        if (!user) {
            // Better error message with hint
            const userCount = db.getUsers().length;
            console.log(`Login failed. Users in database: ${userCount}`);
            utils.showToast(`Benutzer nicht gefunden. Bitte prüfen Sie Ihre E-Mail-Adresse.`, 'error');
            return;
        }

        if (user.password !== password) {
            utils.showToast('Falsches Passwort', 'error');
            return;
        }

        if (user.status === 'pending') {
            utils.showToast('Ihr Account wartet noch auf Freigabe durch einen Administrator', 'warning');
            return;
        }

        if (user.status === 'inactive') {
            utils.showToast('Ihr Account wurde deaktiviert', 'error');
            return;
        }

        // Successful login
        this.currentUser = user;
        this.setSession(user);
        utils.showToast(`Willkommen zurück, ${user.name}!`, 'success');
        this.showMainApp();
    },

    handleRegistration() {
        const name = document.getElementById('regName').value;
        const email = document.getElementById('regEmail').value;
        const password = document.getElementById('regPassword').value;
        const phone = document.getElementById('regPhone').value;
        const teamLeaderId = document.getElementById('regTeamLeader').value;

        // Validate
        if (!utils.isValidEmail(email)) {
            utils.showToast('Bitte geben Sie eine gültige E-Mail-Adresse ein', 'error');
            return;
        }

        if (password.length < 6) {
            utils.showToast('Passwort muss mindestens 6 Zeichen lang sein', 'error');
            return;
        }

        // Check if email already exists
        if (db.getUserByEmail(email)) {
            utils.showToast('Diese E-Mail-Adresse ist bereits registriert', 'error');
            return;
        }

        // Create pending registration
        const registration = {
            id: utils.generateId(),
            name,
            email,
            password,
            phone,
            teamLeaderId: teamLeaderId || null,
            requestedAt: Date.now()
        };

        db.addPendingRegistration(registration);

        utils.showToast('Ihre Registrierung wurde erfolgreich eingereicht! Sie erhalten eine Benachrichtigung, sobald Ihr Account freigegeben wurde.', 'success');
        
        // Clear form
        document.getElementById('registerForm').reset();
        this.switchTab('login');
    },

    logout() {
        if (utils.confirm('Möchten Sie sich wirklich abmelden?')) {
            this.clearSession();
            this.currentUser = null;
            utils.showToast('Sie wurden erfolgreich abgemeldet', 'info');
            this.showLoginScreen();
        }
    },

    switchTab(tab) {
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const tabs = document.querySelectorAll('.auth-tab');

        tabs.forEach(t => t.classList.remove('active'));

        if (tab === 'login') {
            loginForm.style.display = 'flex';
            registerForm.style.display = 'none';
            tabs[0].classList.add('active');
        } else {
            loginForm.style.display = 'none';
            registerForm.style.display = 'flex';
            tabs[1].classList.add('active');
        }
    },

    showLoginScreen() {
        document.getElementById('loginScreen').style.display = 'flex';
        document.getElementById('app').style.display = 'none';
    },

    showMainApp() {
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('app').style.display = 'block';
        
        // Update header with user name
        const userNameEl = document.getElementById('headerUserName');
        if (userNameEl) {
            userNameEl.textContent = this.currentUser.name;
        }
        
        // Build navigation
        this.buildNavigation();
        
        // Initialize main app
        if (typeof app !== 'undefined') {
            app.init();
        }
    },

    buildNavigation() {
        const nav = document.getElementById('mainNav');
        if (!nav) return;

        const navItems = [
            { id: 'dashboard', icon: 'fa-chart-line', label: 'Dashboard' },
            { id: 'leads', icon: 'fa-users', label: 'Leads' },
            { id: 'calls', icon: 'fa-phone', label: 'Anrufe' },
            { id: 'followup', icon: 'fa-calendar-check', label: 'Follow-up' },
            { id: 'reflection', icon: 'fa-clipboard-list', label: 'Wochenreflexion' },
            { id: 'monthly', icon: 'fa-chart-bar', label: 'Monatsübersicht' },
            { id: 'income-calculator', icon: 'fa-calculator', label: 'Einkommen' },
            { id: 'materials', icon: 'fa-file-pdf', label: 'Materialien' }
        ];

        // Add admin item if user is admin
        if (this.currentUser.role === 'admin') {
            navItems.push({ id: 'admin', icon: 'fa-users-cog', label: 'Admin', class: 'admin-only' });
        }

        nav.innerHTML = navItems.map(item => `
            <button class="nav-item ${item.class || ''}" onclick="app.navigateTo('${item.id}')">
                <i class="fas ${item.icon}"></i>
                <span>${item.label}</span>
            </button>
        `).join('');
    },

    // Session management
    setSession(user) {
        sessionStorage.setItem('healthbox_session', JSON.stringify(user));
    },

    getSession() {
        const session = sessionStorage.getItem('healthbox_session');
        return session ? JSON.parse(session) : null;
    },

    clearSession() {
        sessionStorage.removeItem('healthbox_session');
    },

    // Authorization checks
    isAdmin() {
        return this.currentUser && this.currentUser.role === 'admin';
    },

    isTeamLeader() {
        return this.currentUser && this.currentUser.role === 'teamleader';
    },

    isPartner() {
        return this.currentUser && this.currentUser.role === 'partner';
    },

    canViewUser(userId) {
        if (this.isAdmin()) return true;
        if (this.currentUser.id === userId) return true;
        
        if (this.isTeamLeader()) {
            const user = db.getUserById(userId);
            return user && user.teamLeaderId === this.currentUser.id;
        }
        
        return false;
    },

    canEditUser(userId) {
        if (this.isAdmin()) return true;
        return this.currentUser.id === userId;
    },

    getAccessibleUsers() {
        if (this.isAdmin()) {
            return db.getUsers();
        }
        
        if (this.isTeamLeader()) {
            const users = db.getUsers();
            return users.filter(u => 
                u.id === this.currentUser.id || 
                u.teamLeaderId === this.currentUser.id
            );
        }
        
        return [this.currentUser];
    },

    getAccessibleUserIds() {
        return this.getAccessibleUsers().map(u => u.id);
    }
};
